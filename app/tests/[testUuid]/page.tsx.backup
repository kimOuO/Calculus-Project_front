'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import { useParams } from 'next/navigation';
import {
  Button,
  LoadingSpinner,
  UploadTestFileModal,
} from '@/components';
import { useUploadFile } from '@/hooks';
import { getTest, downloadFile, updateTestStatus } from '@/services/api';
import type { Test, AssetType } from '@/types';

export default function TestDetailPage() {
  const params = useParams();
  const testUuid = params.testUuid as string;

  const [test, setTest] = useState<Test | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);
  
  // Image states
  const [paperUrl, setPaperUrl] = useState<string | null>(null);
  const [histogramUrl, setHistogramUrl] = useState<string | null>(null);
  const [paperError, setPaperError] = useState(false);
  const [histogramError, setHistogramError] = useState(false);

  const { upload } = useUploadFile();

  // Load test data
  useEffect(() => {
    const loadTest = async () => {
      try {
        setIsLoading(true);
        const data = await getTest(testUuid);
        setTest(data);
      } catch (err) {
        setError(err instanceof Error ? err.message : '載入失敗');
      } finally {
        setIsLoading(false);
      }
    };

    loadTest();
  }, [testUuid]);

  // Load images when test data is available
  useEffect(() => {
    if (!test || !test.pt_opt_score_uuid) {
      setPaperUrl(null);
      setHistogramUrl(null);
      return;
    }

    const loadImages = async () => {
      // Load paper
      try {
        const paperBlob = await downloadFile({
          test_pic_uuid: test.pt_opt_score_uuid,
          asset_type: 'paper',
        });
        if (paperUrl) URL.revokeObjectURL(paperUrl);
        const url = URL.createObjectURL(paperBlob);
        setPaperUrl(url);
        setPaperError(false);
      } catch (err) {
        console.error('Failed to load paper:', err);
        setPaperError(true);
        setPaperUrl(null);
      }

      // Load histogram
      try {
        const histogramBlob = await downloadFile({
          test_pic_uuid: test.pt_opt_score_uuid,
          asset_type: 'histogram',
        });
        if (histogramUrl) URL.revokeObjectURL(histogramUrl);
        const url = URL.createObjectURL(histogramBlob);
        setHistogramUrl(url);
        setHistogramError(false);
      } catch (err) {
        console.error('Failed to load histogram:', err);
        setHistogramError(true);
        setHistogramUrl(null);
      }
    };

    loadImages();

    // Cleanup URLs on unmount or when test changes
    return () => {
      if (paperUrl) URL.revokeObjectURL(paperUrl);
      if (histogramUrl) URL.revokeObjectURL(histogramUrl);
    };
  }, [test?.pt_opt_score_uuid]);

  const handleUpload = async (assetType: AssetType, files: File[]) => {
    if (!test) return;

    try {
      await upload({
        test_uuid: test.test_uuid,
        asset_type: assetType,
        files,
      });

      // Update test status to "考卷完成" if uploading paper
      if (assetType === 'paper' && test.test_states === '尚未出考卷') {
        await updateTestStatus({
          test_uuid: test.test_uuid,
          test_states: '考卷完成',
        });
      }

      alert('上傳成功！');
      
      // Reload test data and images
      const updatedTest = await getTest(testUuid);
      setTest(updatedTest);
      
      // Reload the specific image
      if (assetType === 'paper') {
        setPaperError(false);
        const paperBlob = await downloadFile({
          test_pic_uuid: updatedTest.pt_opt_score_uuid,
          asset_type: 'paper',
        });
        if (paperUrl) URL.revokeObjectURL(paperUrl);
        setPaperUrl(URL.createObjectURL(paperBlob));
      } else if (assetType === 'histogram') {
        setHistogramError(false);
        const histogramBlob = await downloadFile({
          test_pic_uuid: updatedTest.pt_opt_score_uuid,
          asset_type: 'histogram',
        });
        if (histogramUrl) URL.revokeObjectURL(histogramUrl);
        setHistogramUrl(URL.createObjectURL(histogramBlob));
      }
    } catch (err) {
      alert('上傳失敗：' + (err instanceof Error ? err.message : '未知錯誤'));
      throw err;
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <LoadingSpinner />
      </div>
    );
  }

  if (error || !test) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <h2 className="text-2xl font-bold text-red-600 mb-4">載入失敗</h2>
          <p className="text-gray-600 mb-4">{error || '考試不存在'}</p>
          <Link href="/tests">
            <Button>返回考試列表</Button>
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          <Link
            href="/tests"
            className="text-blue-600 hover:text-blue-800 mb-2 inline-block"
          >
            ← 返回考試列表
          </Link>
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-gray-900">{test.test_name}</h1>
              <div className="mt-2 text-gray-600 space-y-1">
                <p><strong>考試日期:</strong> {test.test_date}</p>
                <p><strong>考試範圍:</strong> {test.test_range}</p>
                <p><strong>學期:</strong> {test.test_semester}</p>
                <p><strong>權重:</strong> {test.test_weight ? `${(parseFloat(test.test_weight) * 100).toFixed(0)}%` : '未設定'}</p>
                <p><strong>狀態:</strong> {test.test_states}</p>
                {test.pt_opt_score_uuid && (
                  <p className="text-sm text-gray-500"><strong>File UUID:</strong> {test.pt_opt_score_uuid}</p>
                )}
              </div>
            </div>
            <Button onClick={() => setIsUploadModalOpen(true)}>
              上傳文件
            </Button>
          </div>
        </div>
      </div>

      {/* Conten{/* PDF viewer or image display */}
                {paperUrl.includes('.pdf') || paperUrl.startsWith('blob:') ? (
                  <div className="border rounded-lg p-4 bg-gray-50">
                    <div className="flex items-center justify-center space-x-2 mb-4">
                      <svg className="w-16 h-16 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" />
                      </svg>
                      <div>
                        <p className="font-semibold text-lg">PDF 文件</p>
                        <p className="text-sm text-gray-600">點擊下方按鈕查看或下載</p>
                      </div>
                    </div>
                    <Button
                      variant="primary"
                      onClick={() => window.open(paperUrl, '_blank')}
                      className="w-full"
                    >
                      開啟 PDF 文件
                    </Button>
                  </div>
                ) : (
                  <>
                    <img
                      src={paperUrl}
                      alt="考卷"
                      className="w-full border rounded-lg"
                      onError={() => setPaperError(true)}
                    />
                    <Button
                      variant="secondary"
                      onClick={() => window.open(paperUrl, '_blank')}
                      className="w-full"
                    >
                      在新視窗中查看
                    </Button>
                  </>
                )}={() => setPaperError(true)}
                />
                <Button
                  variant="secondary"
                  onClick={() => window.open(paperUrl, '_blank')}
                  className="w-full"
                >
                  在新視窗中查看
                </Button>
              </div>
            ) : (
              <div className="text-center text-gray-500 p-8 border rounded-lg bg-gray-50">
                <svg className="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p className="font-medium">尚未上傳考卷</p>
                <p className="text-sm mt-2">點擊右上方「上傳文件」按鈕上傳考卷</p>
                <Button
                  className="mt-4"
                  onClick={() => setIsUploadModalOpen(true)}
                  variant="secondary"
                  size="sm"
                >
                  立即上傳
                </Button>
              </div>
            )}
          </div>

          {/* 直方圖 */}
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-bold mb-4">成績分布直方圖</h2>
            {histogramUrl && !histogramError ? (
              <div className="space-y-4">
                <img
                  src={histogramUrl}
                  alt="直方圖"
                  className="w-full border rounded-lg"
                  onError={() => setHistogramError(true)}
                />
                <Button
                  variant="secondary"
                  onClick={() => window.open(histogramUrl, '_blank')}
                  className="w-full"
                >
                  在新視窗中查看
                </Button>
              </div>
            ) : (
              <div className="text-center text-gray-500 p-8 border rounded-lg bg-gray-50">
                <svg className="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <p className="font-medium">尚未上傳直方圖</p>
                <p className="text-sm mt-2">點擊右上方「上傳文件」按鈕上傳直方圖</p>
                <Button
                  className="mt-4"
                  onClick={() => setIsUploadModalOpen(true)}
                  variant="secondary"
                  size="sm"
                >
                  立即上傳
                </Button>
              </div>
            )}
          </div>
        </div>

        {/* Additional Info */}
        {!test.pt_opt_score_uuid && (
          <div className="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div className="flex">
              <svg className="h-5 w-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
              </svg>
              <div>
                <h3 className="text-sm font-medium text-yellow-800">提示</h3>
                <p className="mt-1 text-sm text-yellow-700">
                  此考試尚未上傳任何文件。請先上傳考卷文件後，才能查看考卷和直方圖。
                </p>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Upload Test File Modal */}
      {test && (
        <UploadTestFileModal
          isOpen={isUploadModalOpen}
          onClose={() => setIsUploadModalOpen(false)}
          onSubmit={handleUpload}
          test={test}
        />
      )}
    </div>
  );
}
